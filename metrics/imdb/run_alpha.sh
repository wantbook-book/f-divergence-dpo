#!/bin/bash

ckpt_path="/pubshare/fwk/dpo_cache/jovyan/imdb_dpo_alpha_divergence_0.1_gpt2_large_hh0.01_10_epochs_2024-09-11_13-48-38_314881"
 root_dir="/home/jovyan/notebook/f-divergence-dpo/outputs/alpha0.1_imdb"
# checkpoints=("step-4992"  "step-4992" "step-9984" "step-9984" "step-14976" "step-19968" "step-24960" "step-29952" "step-34944" "step-39936" "step-44928" "step-49920" "step-54912" "step-59904" "step-64896" "step-69888" "step-74880" "step-79872" "step-84864" "step-89856" "step-94848" "step-99840" "step-104832" "step-109824" "step-114816" "step-119808" "step-124800" "step-129792" "step-134784" "step-139776" "step-144768" "step-149760" "step-154752" "step-159744" "step-164736" "step-169728" "step-174720" "step-179712" "step-184704" "step-189696" "step-194688" "step-199680" "step-204672" "step-209664" "step-214656" "step-219648" "step-224640" "step-229632" "step-234624" "step-239616" "step-244608" "step-249600" "LATEST" "LATEST")

checkpoints=("step-128" "step-256" "step-384" "step-512" "step-640" "step-768" "step-896" "step-1024" "step-1152" "step-1280" "step-1408" "step-1536" "step-1664" "step-1792" "step-1920" "step-2048" "step-2176" "step-2304" "step-2432" "step-2560" "step-2688" "step-2816" "step-2944" "step-3072" "step-3200" "step-3328" "step-3456" "step-3584" "step-3712" "step-3840" "step-3968" "step-4096" "step-4224" "step-4352" "step-4480" "step-4608" "step-4736" "step-4864" "step-4992" "step-5120" "step-5248" "step-5376" "step-5504" "step-5632" "step-5760" "step-5888" "step-6016" "step-6144" "step-6272" "step-6400" "step-6528" "step-6656" "step-6784" "step-6912" "step-7040" "step-7168" "step-7296" "step-7424" "step-7552" "step-7680" "step-7808" "step-7936" "step-8064" "step-8192" "step-8320" "step-8448" "step-8576" "step-8704" "step-8832" "step-8960" "step-9088" "step-9216" "step-9344" "step-9472" "step-9600" "step-9728" "step-9856" "step-9984" "step-10112" "step-10240" "step-10368" "step-10496" "step-10624" "step-10752" "step-10880" "step-11008" "step-11136" "step-11264" "step-11392" "step-11520" "step-11648" "step-11776" "step-11904" "step-12032" "step-12160" "step-12288" "step-12416" "step-12544" "step-12672" "step-12800" "step-12928" "step-13056" "step-13184" "step-13312" "step-13440" "step-13568" "step-13696" "step-13824" "step-13952" "step-14080" "step-14208" "step-14336" "step-14464" "step-14592" "step-14720" "step-14848" "step-14976" "step-15104" "step-15232" "step-15360" "step-15488" "step-15616" "step-15744" "step-15872" "step-16000" "step-16128" "step-16256" "step-16384" "step-16512" "step-16640" "step-16768" "step-16896" "step-17024" "step-17152" "step-17280" "step-17408" "step-17536" "step-17664" "step-17792" "step-17920" "step-18048" "step-18176" "step-18304" "step-18432" "step-18560" "step-18688" "step-18816" "step-18944" "step-19072" "step-19200" "step-19328" "step-19456" "step-19584" "step-19712" "step-19840" "step-19968" "step-20096" "step-20224" "step-20352" "step-20480" "step-20608" "step-20736" "step-20864" "step-20992" "step-21120" "step-21248" "step-21376" "step-21504" "step-21632" "step-21760" "step-21888" "step-22016" "step-22144" "step-22272" "step-22400" "step-22528" "step-22656" "step-22784" "step-22912" "step-23040" "step-23168" "step-23296" "step-23424" "step-23552" "step-23680" "step-23808" "step-23936" "step-24064" "step-24192" "step-24320" "step-24448" "step-24576" "step-24704" "step-24832" "step-24960" "step-25088" "step-25216" "step-25344" "step-25472" "step-25600" "step-25728" "step-25856" "step-25984" "step-26112" "step-26240" "step-26368" "step-26496" "step-26624" "step-26752" "step-26880" "step-27008" "step-27136" "step-27264" "step-27392" "step-27520" "step-27648" "step-27776" "step-27904" "step-28032" "step-28160" "step-28288" "step-28416" "step-28544" "step-28672" "step-28800" "step-28928" "step-29056" "step-29184" "step-29312" "step-29440" "step-29568" "step-29696" "step-29824" "step-29952" "step-30080" "step-30208" "step-30336" "step-30464" "step-30592" "step-30720" "step-30848" "step-30976" "step-31104" "step-31232" "step-31360" "step-31488" "step-31616" "step-31744" "step-31872" "step-32000" "step-32128" "step-32256" "step-32384" "step-32512" "step-32640" "step-32768" "step-32896" "step-33024" "step-33152" "step-33280" "step-33408" "step-33536" "step-33664" "step-33792" "step-33920" "step-34048" "step-34176" "step-34304" "step-34432" "step-34560" "step-34688" "step-34816" "step-34944" "step-35072" "step-35200" "step-35328" "step-35456" "step-35584" "step-35712" "step-35840" "step-35968" "step-36096" "step-36224" "step-36352" "step-36480" "step-36608" "step-36736" "step-36864" "step-36992" "step-37120" "step-37248" "step-37376" "step-37504" "step-37632" "step-37760" "step-37888" "step-38016" "step-38144" "step-38272" "step-38400" "step-38528" "step-38656" "step-38784" "step-38912" "step-39040" "step-39168" "step-39296" "step-39424" "step-39552" "step-39680" "step-39808" "step-39936" "step-40064" "step-40192" "step-40320" "step-40448" "step-40576" "step-40704" "step-40832" "step-40960" "step-41088" "step-41216" "step-41344" "step-41472" "step-41600" "step-41728" "step-41856" "step-41984" "step-42112" "step-42240" "step-42368" "step-42496" "step-42624" "step-42752" "step-42880" "step-43008" "step-43136" "step-43264" "step-43392" "step-43520" "step-43648" "step-43776" "step-43904" "step-44032" "step-44160" "step-44288" "step-44416" "step-44544" "step-44672" "step-44800" "step-44928" "step-45056" "step-45184" "step-45312" "step-45440" "step-45568" "step-45696" "step-45824" "step-45952" "step-46080" "step-46208" "step-46336" "step-46464" "step-46592" "step-46720" "step-46848" "step-46976" "step-47104" "step-47232" "step-47360" "step-47488" "step-47616" "step-47744" "step-47872" "step-48000" "step-48128" "step-48256" "step-48384" "step-48512" "step-48640" "step-48768" "step-48896" "step-49024" "step-49152" "step-49280" "step-49408" "step-49536" "step-49664" "step-49792" "step-49920" "step-50048" "step-50176" "step-50304" "step-50432" "step-50560" "step-50688" "step-50816" "step-50944" "step-51072" "step-51200" "step-51328" "step-51456" "step-51584" "step-51712" "step-51840" "step-51968" "step-52096" "step-52224" "step-52352" "step-52480" "step-52608" "step-52736" "step-52864" "step-52992" "step-53120" "step-53248" "step-53376" "step-53504" "step-53632" "step-53760" "step-53888" "step-54016" "step-54144" "step-54272" "step-54400" "step-54528" "step-54656" "step-54784" "step-54912" "step-55040" "step-55168" "step-55296" "step-55424" "step-55552" "step-55680" "step-55808" "step-55936" "step-56064" "step-56192" "step-56320" "step-56448" "step-56576" "step-56704" "step-56832" "step-56960" "step-57088" "step-57216" "step-57344" "step-57472" "step-57600" "step-57728" "step-57856" "step-57984" "step-58112" "step-58240" "step-58368" "step-58496" "step-58624" "step-58752" "step-58880" "step-59008" "step-59136" "step-59264" "step-59392" "step-59520" "step-59648" "step-59776" "step-59904" "step-60032" "step-60160" "step-60288" "step-60416" "step-60544" "step-60672" "step-60800" "step-60928" "step-61056" "step-61184" "step-61312" "step-61440" "step-61568" "step-61696" "step-61824" "step-61952" "step-62080" "step-62208" "step-62336" "step-62464" "step-62592" "step-62720" "step-62848" "step-62976" "step-63104" "step-63232" "step-63360" "step-63488" "step-63616" "step-63744" "step-63872" "step-64000" "step-64128" "step-64256" "step-64384" "step-64512" "step-64640" "step-64768" "step-64896" "step-65024" "step-65152" "step-65280" "step-65408" "step-65536" "step-65664" "step-65792" "step-65920" "step-66048" "step-66176" "step-66304" "step-66432" "step-66560" "step-66688" "step-66816" "step-66944" "step-67072" "step-67200" "step-67328" "step-67456" "step-67584" "step-67712" "step-67840" "step-67968" "step-68096" "step-68224" "step-68352" "step-68480" "step-68608" "step-68736" "step-68864" "step-68992" "step-69120" "step-69248" "step-69376" "step-69504" "step-69632" "step-69760" "step-69888" "step-70016" "step-70144" "step-70272" "step-70400" "step-70528" "step-70656" "step-70784" "step-70912" "step-71040" "step-71168" "step-71296" "step-71424" "step-71552" "step-71680" "step-71808" "step-71936" "step-72064" "step-72192" "step-72320" "step-72448" "step-72576" "step-72704" "step-72832" "step-72960" "step-73088" "step-73216" "step-73344" "step-73472" "step-73600" "step-73728" "step-73856" "step-73984" "step-74112" "step-74240" "step-74368" "step-74496" "step-74624" "step-74752" "step-74880" "step-75008" "step-75136" "step-75264" "step-75392" "step-75520" "step-75648" "step-75776" "step-75904" "step-76032" "step-76160" "step-76288" "step-76416" "step-76544" "step-76672" "step-76800" "step-76928" "step-77056" "step-77184" "step-77312" "step-77440" "step-77568" "step-77696" "step-77824" "step-77952" "step-78080" "step-78208" "step-78336" "step-78464" "step-78592" "step-78720" "step-78848" "step-78976" "step-79104" "step-79232" "step-79360" "step-79488" "step-79616" "step-79744" "step-79872" "step-80000" "step-80128" "step-80256" "step-80384" "step-80512" "step-80640" "step-80768" "step-80896" "step-81024" "step-81152" "step-81280" "step-81408" "step-81536" "step-81664" "step-81792" "step-81920" "step-82048" "step-82176" "step-82304" "step-82432" "step-82560" "step-82688" "step-82816" "step-82944" "step-83072" "step-83200" "step-83328" "step-83456" "step-83584" "step-83712" "step-83840" "step-83968" "step-84096" "step-84224" "step-84352" "step-84480" "step-84608" "step-84736" "step-84864" "step-84992" "step-85120" "step-85248" "step-85376" "step-85504" "step-85632" "step-85760" "step-85888" "step-86016" "step-86144" "step-86272" "step-86400" "step-86528" "step-86656" "step-86784" "step-86912" "step-87040" "step-87168" "step-87296" "step-87424" "step-87552" "step-87680" "step-87808" "step-87936" "step-88064" "step-88192" "step-88320" "step-88448" "step-88576" "step-88704" "step-88832" "step-88960" "step-89088" "step-89216" "step-89344" "step-89472" "step-89600" "step-89728" "step-89856" "step-89984" "step-90112" "step-90240" "step-90368" "step-90496" "step-90624" "step-90752" "step-90880" "step-91008" "step-91136" "step-91264" "step-91392" "step-91520" "step-91648" "step-91776" "step-91904" "step-92032" "step-92160" "step-92288" "step-92416" "step-92544" "step-92672" "step-92800" "step-92928" "step-93056" "step-93184" "step-93312" "step-93440" "step-93568" "step-93696" "step-93824" "step-93952" "step-94080" "step-94208" "step-94336" "step-94464" "step-94592" "step-94720" "step-94848" "step-94976" "step-95104" "step-95232" "step-95360" "step-95488" "step-95616" "step-95744" "step-95872" "step-96000" "step-96128" "step-96256" "step-96384" "step-96512" "step-96640" "step-96768" "step-96896" "step-97024" "step-97152" "step-97280" "step-97408" "step-97536" "step-97664" "step-97792" "step-97920" "step-98048" "step-98176" "step-98304" "step-98432" "step-98560" "step-98688" "step-98816" "step-98944" "step-99072" "step-99200" "step-99328" "step-99456" "step-99584" "step-99712" "step-99840" "step-99968" "step-100096" "step-100224" "step-100352" "step-100480" "step-100608" "step-100736" "step-100864" "step-100992" "step-101120" "step-101248" "step-101376" "step-101504" "step-101632" "step-101760" "step-101888" "step-102016" "step-102144" "step-102272" "step-102400" "step-102528" "step-102656" "step-102784" "step-102912" "step-103040" "step-103168" "step-103296" "step-103424" "step-103552" "step-103680" "step-103808" "step-103936" "step-104064" "step-104192" "step-104320" "step-104448" "step-104576" "step-104704" "step-104832" "step-104960" "step-105088" "step-105216" "step-105344" "step-105472" "step-105600" "step-105728" "step-105856" "step-105984" "step-106112" "step-106240" "step-106368" "step-106496" "step-106624" "step-106752" "step-106880" "step-107008" "step-107136" "step-107264" "step-107392" "step-107520" "step-107648" "step-107776" "step-107904" "step-108032" "step-108160" "step-108288" "step-108416" "step-108544" "step-108672" "step-108800" "step-108928" "step-109056" "step-109184" "step-109312" "step-109440" "step-109568" "step-109696" "step-109824" "step-109952" "step-110080" "step-110208" "step-110336" "step-110464" "step-110592" "step-110720" "step-110848" "step-110976" "step-111104" "step-111232" "step-111360" "step-111488" "step-111616" "step-111744" "step-111872" "step-112000" "step-112128" "step-112256" "step-112384" "step-112512" "step-112640" "step-112768" "step-112896" "step-113024" "step-113152" "step-113280" "step-113408" "step-113536" "step-113664" "step-113792" "step-113920" "step-114048" "step-114176" "step-114304" "step-114432" "step-114560" "step-114688" "step-114816" "step-114944" "step-115072" "step-115200" "step-115328" "step-115456" "step-115584" "step-115712" "step-115840" "step-115968" "step-116096" "step-116224" "step-116352" "step-116480" "step-116608" "step-116736" "step-116864" "step-116992" "step-117120" "step-117248" "step-117376" "step-117504" "step-117632" "step-117760" "step-117888" "step-118016" "step-118144" "step-118272" "step-118400" "step-118528" "step-118656" "step-118784" "step-118912" "step-119040" "step-119168" "step-119296" "step-119424" "step-119552" "step-119680" "step-119808" "step-119936" "step-120064" "step-120192" "step-120320" "step-120448" "step-120576" "step-120704" "step-120832" "step-120960" "step-121088" "step-121216" "step-121344" "step-121472" "step-121600" "step-121728" "step-121856" "step-121984" "step-122112" "step-122240" "step-122368" "step-122496" "step-122624" "step-122752" "step-122880" "step-123008" "step-123136" "step-123264" "step-123392" "step-123520" "step-123648" "step-123776" "step-123904" "step-124032" "step-124160" "step-124288" "step-124416" "step-124544" "step-124672" "step-124800" "step-124928" "step-125056" "step-125184" "step-125312" "step-125440" "step-125568" "step-125696" "step-125824" "step-125952" "step-126080" "step-126208" "step-126336" "step-126464" "step-126592" "step-126720" "step-126848" "step-126976" "step-127104" "step-127232" "step-127360" "step-127488" "step-127616" "step-127744" "step-127872" "step-128000" "step-128128" "step-128256" "step-128384" "step-128512" "step-128640" "step-128768" "step-128896" "step-129024" "step-129152" "step-129280" "step-129408" "step-129536" "step-129664" "step-129792" "step-129920" "step-130048" "step-130176" "step-130304" "step-130432" "step-130560" "step-130688" "step-130816" "step-130944" "step-131072" "step-131200" "step-131328" "step-131456" "step-131584" "step-131712" "step-131840" "step-131968" "step-132096" "step-132224" "step-132352" "step-132480" "step-132608" "step-132736" "step-132864" "step-132992" "step-133120" "step-133248" "step-133376" "step-133504" "step-133632" "step-133760" "step-133888" "step-134016" "step-134144" "step-134272" "step-134400" "step-134528" "step-134656" "step-134784" "step-134912" "step-135040" "step-135168" "step-135296" "step-135424" "step-135552" "step-135680" "step-135808" "step-135936" "step-136064" "step-136192" "step-136320" "step-136448" "step-136576" "step-136704" "step-136832" "step-136960" "step-137088" "step-137216" "step-137344" "step-137472" "step-137600" "step-137728" "step-137856" "step-137984" "step-138112" "step-138240" "step-138368" "step-138496" "step-138624" "step-138752" "step-138880" "step-139008" "step-139136" "step-139264" "step-139392" "step-139520" "step-139648" "step-139776" "step-139904" "step-140032" "step-140160" "step-140288" "step-140416" "step-140544" "step-140672" "step-140800" "step-140928" "step-141056" "step-141184" "step-141312" "step-141440" "step-141568" "step-141696" "step-141824" "step-141952" "step-142080" "step-142208" "step-142336" "step-142464" "step-142592" "step-142720" "step-142848" "step-142976" "step-143104" "step-143232" "step-143360" "step-143488" "step-143616" "step-143744" "step-143872" "step-144000" "step-144128" "step-144256" "step-144384" "step-144512" "step-144640" "step-144768" "step-144896" "step-145024" "step-145152" "step-145280" "step-145408" "step-145536" "step-145664" "step-145792" "step-145920" "step-146048" "step-146176" "step-146304" "step-146432" "step-146560" "step-146688" "step-146816" "step-146944" "step-147072" "step-147200" "step-147328" "step-147456" "step-147584" "step-147712" "step-147840" "step-147968" "step-148096" "step-148224" "step-148352" "step-148480" "step-148608" "step-148736" "step-148864" "step-148992" "step-149120" "step-149248" "step-149376" "step-149504" "step-149632" "step-149760" "step-149888" "step-150016" "step-150144" "step-150272" "step-150400" "step-150528" "step-150656" "step-150784" "step-150912" "step-151040" "step-151168" "step-151296" "step-151424" "step-151552" "step-151680" "step-151808" "step-151936" "step-152064" "step-152192" "step-152320" "step-152448" "step-152576" "step-152704" "step-152832" "step-152960" "step-153088" "step-153216" "step-153344" "step-153472" "step-153600" "step-153728" "step-153856" "step-153984" "step-154112" "step-154240" "step-154368" "step-154496" "step-154624" "step-154752" "step-154880" "step-155008" "step-155136" "step-155264" "step-155392" "step-155520" "step-155648" "step-155776" "step-155904" "step-156032" "step-156160" "step-156288" "step-156416" "step-156544" "step-156672" "step-156800" "step-156928" "step-157056" "step-157184" "step-157312" "step-157440" "step-157568" "step-157696" "step-157824" "step-157952" "step-158080" "step-158208" "step-158336" "step-158464" "step-158592" "step-158720" "step-158848" "step-158976" "step-159104" "step-159232" "step-159360" "step-159488" "step-159616" "step-159744" "step-159872" "step-160000" "step-160128" "step-160256" "step-160384" "step-160512" "step-160640" "step-160768" "step-160896" "step-161024" "step-161152" "step-161280" "step-161408" "step-161536" "step-161664" "step-161792" "step-161920" "step-162048" "step-162176" "step-162304" "step-162432" "step-162560" "step-162688" "step-162816" "step-162944" "step-163072" "step-163200" "step-163328" "step-163456" "step-163584" "step-163712" "step-163840" "step-163968" "step-164096" "step-164224" "step-164352" "step-164480" "step-164608" "step-164736" "step-164864" "step-164992" "step-165120" "step-165248" "step-165376" "step-165504" "step-165632" "step-165760" "step-165888" "step-166016" "step-166144" "step-166272" "step-166400" "step-166528" "step-166656" "step-166784" "step-166912" "step-167040" "step-167168" "step-167296" "step-167424" "step-167552" "step-167680" "step-167808")


# iterate through each directory
for (( i=0; i<${#checkpoints[@]}; i+=1 ))
do
  checkpoint=${checkpoints[$i]}
  # perform operations on $checkpoint
  echo "$checkpoint"
done | CUDA_VISIBLE_DEVICES=2 ROOT_DIR=$root_dir xargs -I {} -P 1 python metrics/imdb/imdb_eval_metrics.py --checkpoint $ckpt_path/{}/policy.pt --divergence alpha_divergence --alpha 0.1


# ckpt_path='.cache/chaoqi/imdb_dpo_alpha_divergence_0.3_gpt2_large_hh0.01_10_epochs_2023-07-14_12-21-44_404353'
# for (( i=0; i<${#checkpoints[@]}; i+=2 ))
# do
#   checkpoint=${checkpoints[$i]}
#   # perform operations on $checkpoint
#   echo "$checkpoint"
# done | xargs -I {} -P 25 srun --gres=gpu:1 -c 6 --mem 60G -p general  --exclude=g002,g005,g006,g007,g008,g009   python metrics/imdb/imdb_eval_metrics.py --checkpoint $ckpt_path/{}/policy.pt --divergence alpha_divergence --alpha 0.3

# ckpt_path='.cache/chaoqi/imdb_dpo_alpha_divergence_0.5_gpt2_large_hh0.01_10_epochs_2023-07-14_12-03-10_093799'
# for (( i=0; i<${#checkpoints[@]}; i+=2 ))
# do
#   checkpoint=${checkpoints[$i]}
#   # perform operations on $checkpoint
#   echo "$checkpoint"
# done | xargs -I {} -P 25 srun --gres=gpu:1 -c 6 --mem 60G -p general  --exclude=g002,g005,g006,g007,g008,g009   python metrics/imdb/imdb_eval_metrics.py --checkpoint $ckpt_path/{}/policy.pt --divergence alpha_divergence --alpha 0.5

# ckpt_path='.cache/chaoqi/imdb_dpo_alpha_divergence_0.7_gpt2_large_hh0.01_10_epochs_2023-07-14_12-21-44_406113'
# for (( i=0; i<${#checkpoints[@]}; i+=2 ))
# do
#   checkpoint=${checkpoints[$i]}
#   # perform operations on $checkpoint
#   echo "$checkpoint"
# done | xargs -I {} -P 25 srun --gres=gpu:1 -c 6 --mem 60G -p general  --exclude=g002,g005,g006,g007,g008,g009   python metrics/imdb/imdb_eval_metrics.py --checkpoint $ckpt_path/{}/policy.pt --divergence alpha_divergence --alpha 0.7

# ckpt_path='.cache/chaoqi/imdb_dpo_alpha_divergence_0.9_gpt2_large_hh0.01_10_epochs_2023-07-14_12-29-13_579851'
# for (( i=0; i<${#checkpoints[@]}; i+=2 ))
# do
#   checkpoint=${checkpoints[$i]}
#   # perform operations on $checkpoint
#   echo "$checkpoint"
# done | xargs -I {} -P 25 srun --gres=gpu:1 -c 6 --mem 60G -p general  --exclude=g002,g005,g006,g007,g008,g009   python metrics/imdb/imdb_eval_metrics.py --checkpoint $ckpt_path/{}/policy.pt --divergence alpha_divergence --alpha 0.9
